<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Colmena No. 8 - Masonería Simbólica</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="Sitio oficial de la Respetable Logia Simbólica Colmena No. 8. Espacio de estudio y trabajos de tradición masónica.">
    <meta name="keywords" content="Masonería, Logia, Colmena 8, Fraternidad, Simbolismo, Trabajos, Google Docs">
    <meta name="author" content="Logia Colmena No. 8">

    <link href='https://fonts.googleapis.com/css?family=MedievalSharp' rel='stylesheet'>

    <style>
        /* (Estilos CSS - Mantenidos para contexto) */
        :root{
            --gold:#D4A017;
            --beige:#F5EFE6;
            --brown:#7A4F35;
            --dark:#37271E;
            --accent:#E7D9C9;
            --radius:14px;
            --maxw:1100px;
            --ff-sans: -apple-system, BlinkMacMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --ff-serif: Georgia, "Times New Roman", serif;
            --ff-medieval: 'MedievalSharp', serif;
        }
        *, *::before, *::after {box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:var(--ff-medieval), var(--ff-sans);
            font-size: 14px;
            color:var(--dark);
            background:linear-gradient(180deg,var(--beige) 0%, #fff 100%);
            -webkit-font-smoothing:antialiased;
            line-height:1.45;
        }
        .container{max-width:var(--maxw);margin:0 auto;padding:28px;}
        header{
            background:linear-gradient(90deg,var(--beige),var(--accent));
            border-radius:var(--radius);
            padding:18px 22px;
            display:flex;
            align-items:center;
            gap:18px;
            box-shadow:0 6px 18px rgba(55,39,30,0.08);
            margin-bottom:20px;
        }
        .logo{
            width:84px;height:84px;border-radius:12px;
            display:flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,#fffefc,rgba(212,160,23,0.08));
            border:2px solid rgba(55,39,30,0.06);
            flex-shrink:0;
        }
        .logo img{max-width: 56px; max-height: 56px;}
        .brand h1{margin:0;font-size:1.5rem;color:var(--dark)}
        .brand p{margin:4px 0 0 0;color:var(--brown);font-size:0.95rem}
        nav{margin-left:auto}
        .nav-list{display:flex;gap:12px;flex-wrap:wrap; list-style: none; padding: 0; margin: 0;}
        .nav-list li a{
            text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:600;
            color:var(--dark);background:transparent;border:2px solid transparent;
        }
        .nav-list li a.cta{
            background:var(--gold);color:#ffffff;border-color:var(--gold);
            box-shadow:0 6px 12px rgba(212,160,23,0.16)
        }
        .hero{
            display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:stretch;
            margin-bottom:22px;
        }
        .card{
            background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 22px rgba(55,39,30,0.06);
        }
        .hero .intro h2{margin-top:0;color:var(--brown);font-family:var(--ff-serif)}
        .hex-grid{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
        .hex{
            width:60px;height:70px;background:linear-gradient(180deg,var(--gold),#f5c869);
            clip-path: polygon(25% 6%,75% 6%,100% 50%,75% 94%,25% 94%,0% 50%);
            display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
            box-shadow:0 4px 10px rgba(55,39,30,0.08)
        }
        .columns{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-bottom:22px}
        .about h3{color:var(--brown);margin-top:0}
        .about p{color:#3b2f2f}
        .trabajos ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .trabajos li {
            padding: 10px 0;
            border-bottom: 1px dashed rgba(55,39,30,0.1);
        }
        .trabajos li:last-child {
            border-bottom: none;
        }
        .trabajos a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 600;
            display: block;
            cursor: pointer; /* Añadido para indicar que es clickeable */
        }
        .trabajos a:hover {
            color: var(--gold);
        }
        .trabajos span {
            display: block;
            font-size: 0.85rem;
            color: var(--brown);
            margin-top: 2px;
        }
        .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
        .gallery img{width:100%;height:120px;object-fit:cover;border-radius:8px;cursor:pointer;display:block}
        #ultima-tenida-img.loading::after {
            content: "Cargando última tenida...";
            display: block;
            text-align: center;
            padding: 20px;
            color: var(--brown);
        }
        /* Estilos base para Lightbox y Modal de Documento (comparten clase .lightbox) */
        .lightbox{
            position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);
            z-index:60;
        }
        .lightbox.open{display:flex}
        /* Estilos específicos para el lightbox de galería */
        #lightbox img{max-width:90%;max-height:80%;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.6)}
        /* Estilos específicos para el modal de documentos */
        #document-modal > div {
            width:90vw; height:90vh; max-width:1000px; max-height:800px; border-radius:10px; overflow:hidden; background:white;
            position: relative; /* Para posicionar el título */
        }
        #doc-iframe {
            display: block;
        }

        footer{margin-top:18px;padding:18px;border-radius:12px;background:linear-gradient(90deg,#fff,#f9f5ef);display:flex;gap:18px;align-items:flex-start;}
        .contact-form{width:420px}
        .contact-form label{margin-top:8px;display:block}
        .contact-form input, .contact-form textarea{
            width:100%;padding:10px;border-radius:8px;border:1px solid rgba(55,39,30,0.08);font-size:0.95rem;
        }
        .contact-form button{
            background:var(--brown);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;
        }
        @media (max-width:880px){
            .hero{grid-template-columns:1fr}
            .columns{grid-template-columns:1fr}
            nav{order:3;width:100%;margin-top:10px}
            .nav-list{justify-content:center}
            footer{flex-direction: column; align-items: stretch;}
            .contact-form{width:100%;}
        }
        .muted{color:#6a4f3e;font-size:0.92rem}
        .small{font-size:0.85rem}
        .medieval-text { font-family: var(--ff-medieval);font-size: 22px; }
        .text-justify { text-align: justify; }
        
        /* Estilo para el botón de Google Calendar */
        #add-to-calendar-btn {
            display: inline-block;
            background-color: #4285F4; /* Azul de Google */
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            font-family: var(--ff-sans);
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header role="banner">
            <div class="logo">
                <img src="images/logo-mini.png" alt="Logo Colmena No. 8">
            </div>

            <div class="brand">
                <h1>Colmena No. 8</h1>
                <p>Masonería</p>
            </div>

            <nav aria-label="Navegación principal">
                <ul class="nav-list">
                    <li><a href="#about">Sobre</a></li>
                    <li><a href="#oficios">Oficiales</a></li>
                    <li><a href="#trabajos">Trabajos</a></li>
                    <li><a href="#galeria">Galería</a></li>
                    <li><a href="#contacto" class="cta">Contacto</a></li>
                </ul>
            </nav>
        </header>

        <section class="hero">
            <article class="card intro" aria-labelledby="intro-title">
                <h2 id="intro-title">Bienvenidos a la Colmena</h2>
                <p class="muted text-justify">La R.·.L.·.S.·. **Colmena No. 8**, es un taller masónico consagrado al perfeccionamiento moral y espiritual de sus miembros,
                    inspirado en la labor de las abejas: ordenadas, laboriosas y solidarias. Nuestra logia es un templo de estudio y trabajo colectivo,
                    donde cada hermano contribuye con su esfuerzo al bien común, edificando juntos un mundo más justo y luminoso.
                    Con la sabiduría heredada de siglos de tradición, Colmena No. 8 mantiene viva la llama de los valores masónicos —libertad, igualdad y fraternidad—,
                    erigiéndose como un faro que guía a quienes buscan el desarrollo interior y el servicio desinteresado a la humanidad.</p>

                <div style="margin-top:14px">
                    <p class="text-justify"><strong>Misión de Nuestra la Orden:</strong> Ser faro de luz en las tinieblas, allí donde el hombre,
                        piedra bruta, se esculpe con el cincel del conocimiento y el mazo de la voluntad. Nuestra misión es custodiar el
                        fuego eterno de la sabiduría, avivarlo en cada corazón sediento de verdad y con manos fraternas, levantar un templo
                        de humanidad. Guiados por la sagrada palabra del Creador, consagramos el despertar conciencias, sembrando la virtud
                        entre los hombres, donde el espíritu colectivo forje el pensamiento verdadero, en busca de la justicia, la belleza y el bien supremo.</p>
                    <div class="hex-grid" aria-hidden="true">
                        <div class="hex">R.·.</div>
                        <div class="hex">L.·.</div>
                        <div class="hex">S.·.</div>
                        <div class="hex">C.·.8</div>
                    </div>
                </div>
            </article>

            <aside class="card" aria-labelledby="datos-title">
                <h3 id="datos-title">Próxima Tenida</h3>
                <p class="muted small" id="tenida-fecha">Cargando fecha del calendario...</p> 
                <p class="small" id="tenida-lugar">Lugar: Templo Colmena No.8 <br>Al este de la montaña del águila</p>
                <hr style="margin:12px 0;border:none;border-top:1px solid rgba(55,39,30,0.06)">
               
                <h4 style="margin-bottom:6px">Contacto rápido</h4>
                <p class="small">Email: <a href="mailto:Rlscolmena8@gmail.com">Rlscolmena8@gmail.com</a></p>
                <p class="small">Tel: +1 (385) 352-3212</p>
                <a href="https://chat.whatsapp.com/Cosmonautas" target="_blank" style="
                    display: inline-block;
                    background-color: #25D366;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 50px;
                    text-decoration: none;
                    font-weight: bold;
                    font-family: Arial, sans-serif;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    💬 Contactar por WhatsApp
                </a>
            </aside>
        </section>

        <section class="columns" id="about">
            <div class="card about" aria-labelledby="about-title">
                <h3 id="about-title">Nuestra historia</h3>
                <p>La Logia Colmena No. 8 fue fundada con el propósito de reunir a hermanos interesados en el perfeccionamiento moral y social. Aquí se combinan estudio, ritual y servicios a la comunidad.</p>
                <p class="small">Los símbolos que usamos —hexágono, abeja, la colmena— representan el trabajo colectivo, la disciplina y la sabiduría compartida.</p>
            </div>

            <aside class="card officers" id="oficios" aria-labelledby="oficios-title">
                <h3 id="oficios-title">Oficiales</h3>
                <ul>
                    <li><strong>Venerable Maestro:</strong> <br> José Guevara</li>
                    <li><strong>Primer Vigilante:</strong> <br> Juan Hernández</li>
                    <li><strong>Segundo Vigilante:</strong> <br> Gustavo Montero</li>
                    <li><strong>Secretario:</strong> <br> Eduardo Hernández</li>
                </ul>
            </aside>
        </section>

        <section class="card trabajos" id="trabajos" aria-labelledby="trabajos-title">
            <h3 id="trabajos-title">Estudios y Trabajos</h3>
            <p class="small muted">Documentos y trazados para el perfeccionamiento de los Hermanos (Se abren en ventana segura).</p>
            <ul id="trabajos-list">
                <li style="text-align:center; padding:15px; color:var(--brown);" class="loading-message">Cargando documentos...</li>
            </ul>
        </section>

        <section class="card" id="galeria" aria-labelledby="galeria-title">
            <h3 id="galeria-title">Galería</h3>
            <p class="small muted">Haz clic sobre una imagen para verla ampliada.</p>
            <div class="gallery" id="image-gallery" aria-live="polite">
                <img src="images/carta-patente.png" alt="Carta Patente">
                <img id="ultima-tenida-img" src="images/placeholder.png" alt="Cargando Última Tenida..." class="loading">
                <img src="images/Cuadro-Logial.png" alt="Cuadro Logial">
                <img src="https://via.placeholder.com/600x400?text=Rituales" alt="Rituales simbólicos">
            </div>
        </section>

        <div id="document-modal" class="lightbox" role="dialog" aria-modal="true" aria-hidden="true">
            <button id="doc-close" style="position:absolute;top:18px;right:22px;background:transparent;border:0;color:#fff;font-size:30px;cursor:pointer;z-index:70;" aria-label="Cerrar documento">&times;</button>
            
            <div style="width:90vw; height:90vh; max-width:1000px; max-height:800px; border-radius:10px; overflow:hidden; background:white;">
                <h4 id="doc-title" style="color:var(--dark); padding:10px 15px; margin:0; font-family:var(--ff-sans); background:var(--accent); border-bottom:1px solid rgba(0,0,0,0.1);">Cargando Documento...</h4>
                <iframe id="doc-iframe" src="" frameborder="0" style="width:100%; height:calc(100% - 46px);" allowfullscreen></iframe>
            </div>
        </div>

        <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-hidden="true">
            <button id="lb-close" style="position:absolute;top:18px;right:22px;background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer" aria-label="Cerrar galería">&times;</button>
            <div style="position:relative;display:inline-block;">
                <img id="lb-img" src="" alt="">
                <div id="lb-caption" style="
                    position:absolute;
                    bottom:12px;
                    left:50%;
                    transform:translateX(-50%);
                    background:rgba(0,0,0,0.7);
                    color:#fff;
                    padding:6px 12px;
                    border-radius:6px;
                    font-size:14px;
                    display:none;
                    max-width:90%;
                    text-align:center;">
                </div>
            </div>
        </div>


        <footer id="contacto" aria-labelledby="contacto-title">
            <div style="flex:1">
                <h3 id="contacto-title">¿Interesado en saber más?</h3>
                <p class="small muted">Escríbenos para consultas sobre admisión, eventos o colaboración.</p>
            </div>

            <form class="contact-form" onsubmit="abrirGmail(event)">
                <label for="nombre" class="small">Nombre</label>
                <input id="nombre" name="nombre" type="text" required placeholder="Tu nombre">

                <label for="email" class="small">Correo</label>
                <input id="email" name="email" type="email" required placeholder="tu@correo">

                <label for="mensaje" class="small">Mensaje</label>
                <textarea id="mensaje" name="mensaje" rows="3" placeholder="Escribe tu mensaje..." required></textarea>

                <div style="display:flex;justify-content:flex-end;margin-top:8px">
                    <button type="submit">Enviar</button>
                </div>
            </form>
            <script>
                // Función para el formulario de contacto
                function abrirGmail(e){
                    e.preventDefault();
                    const nombre = encodeURIComponent(document.getElementById('nombre').value);
                    const email = encodeURIComponent(document.getElementById('email').value);
                    const mensaje = encodeURIComponent(document.getElementById('mensaje').value);
                    window.location.href = `mailto:Rlscolmena8@gmail.com?subject=Mensaje de ${nombre}&body=De: ${email}%0A%0A${mensaje}`;
                }
            </script>
        </footer>

        <p style="text-align:center;color:#6a4f3e;font-size:0.85rem;margin-top:12px" class="small">© Colmena No. 8 — Todos los derechos reservados</p>
    </div>

    <script>
        // =========================================================================
        // === ZONA DE CONFIGURACIÓN OBLIGATORIA (ACTUALIZA ESTOS VALORES) =======
        // =========================================================================
        const GITHUB_USER = 'cyberzona'; 
        const GITHUB_REPO = 'colmena';
        const GITHUB_BRANCH = 'main';          
        
        const IMAGES_PATH = 'images';          
        const DOCS_PATH = 'data';          
        
        // --- Constantes de Trabajos y Galería ---
        const ULTIMA_TENIDA_IMG_ELEMENT = document.getElementById('ultima-tenida-img');
        const TENIDA_FILENAME_REGEX = /^tenida-(\d{4})(\d{2})(\d{2})\.(png|jpg|jpeg|gif|webp)$/i;
        const IMAGE_API_URL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${IMAGES_PATH}?ref=${GITHUB_BRANCH}`;
        
        const TRABAJOS_FILE = 'work-study.json';
        const TRABAJOS_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${DOCS_PATH}/${TRABAJOS_FILE}`;
        const TRABAJOS_LIST_ELEMENT = document.getElementById('trabajos-list');

        // =========================================================================
        // === CONFIGURACIÓN PARA GOOGLE CALENDAR API (OBLIGATORIO) ================
        // =========================================================================

        // ⚠️ 1. REEMPLAZA ESTE VALOR con el ID de tu calendario público de Google
        const CALENDAR_ID = '9d46fca8679c56e5d9dd7a0800eb446f8a06697c8c3233e162d053b15c9b8dc4@group.calendar.google.com'; 
        // ⚠️ 2. REEMPLAZA ESTE VALOR con tu Clave API de Google Cloud Console
        const API_KEY = 'AIzaSyBvH9kdQvKWunKi-IdjDBSKZWODMEcwp-E';         
        
        const DURATION_HOURS = 2;                  
        const TIMEZONE = "America/Denver";         // Huso horario de la logia (ej: America/Mexico_City)


        // =========================================================================
        // === 1. LÓGICA DE CARGA DE TRABAJOS (DESDE JSON RAW Y MODAL) =============
        // =========================================================================
        async function loadTrabajos() {
            if (!TRABAJOS_LIST_ELEMENT) return;          
            try {
                const response = await fetch(TRABAJOS_URL);          
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo obtener ${TRABAJOS_FILE}.`);
                }          
                const trabajos = await response.json();
                TRABAJOS_LIST_ELEMENT.innerHTML = ''; // Limpiar el mensaje de carga
                if (!Array.isArray(trabajos) || trabajos.length === 0) {
                    TRABAJOS_LIST_ELEMENT.innerHTML = '<li style="text-align:center;color:#6a4f3e;">No hay trabajos publicados aún.</li>';
                    return;
                }
                // Renderizar la lista
                trabajos.forEach(trabajo => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="#" data-url="${trabajo.url}" data-titulo="${trabajo.titulo}">
                            ${trabajo.titulo}
                            <span>${trabajo.descripcion}</span>
                        </a>
                    `;
                    // Asignamos el evento que abre el modal
                    li.querySelector('a').addEventListener('click', openDocumentModal);
                    TRABAJOS_LIST_ELEMENT.appendChild(li);
                });

            } catch (error) {
                console.error("Fallo al cargar los trabajos:", error);
                TRABAJOS_LIST_ELEMENT.innerHTML = '<li style="color:#d9534f;text-align:center;">Error al cargar la lista de documentos.</li>';
            }
        }

        // =========================================================================
        // === 2. LÓGICA DEL MODAL DE DOCUMENTOS (OCULTAR URL) =====================
        // =========================================================================
        
        const docModal = document.getElementById('document-modal');
        const docIframe = document.getElementById('doc-iframe');
        const docTitle = document.getElementById('doc-title');
        const docCloseButton = document.getElementById('doc-close');
        
        function openDocumentModal(event) {
            event.preventDefault(); // Evita que el navegador navegue a la URL
            
            const link = event.currentTarget;
            let url = link.getAttribute('data-url');
            const title = link.getAttribute('data-titulo');

            // **MODIFICACIÓN CRUCIAL:** Si es un Google Doc, cambia '/edit' por '/preview'
            if (url.includes('docs.google.com/document')) {
                url = url.replace('/edit', '/preview');
            } else if (url.includes('docs.google.com/spreadsheets')) {
                url = url.replace('/edit', '/pubhtml?widget=true&headers=false');
            }

            docTitle.textContent = `Documento: ${title}`;
            docIframe.src = url;
            docModal.classList.add('open');
            docModal.setAttribute('aria-hidden', 'false');
        }

        function closeDocumentModal() {
            docModal.classList.remove('open');
            docModal.setAttribute('aria-hidden', 'true');
            docIframe.src = ""; // Detener la carga y limpiar la fuente
            docTitle.textContent = "Cargando Documento...";
        }

        // Asignar listeners al modal
        docCloseButton.addEventListener('click', closeDocumentModal);
        docModal.addEventListener('click', (e) => {
            if (e.target === docModal) closeDocumentModal();
        });
        // Permitir cerrar con Escape
        document.addEventListener('keydown', (e) => { 
             if (e.key === 'Escape' && docModal.classList.contains('open')) closeDocumentModal();
        });

        // =========================================================================
        // === 3. LÓGICA DE CARGA DE LA ÚLTIMA IMAGEN DE TENIDA (FILTRADO) =========
        // =========================================================================
        async function fetchLatestTenidaImage() {
            if (!ULTIMA_TENIDA_IMG_ELEMENT) return;
            ULTIMA_TENIDA_IMG_ELEMENT.classList.add('loading'); 
            try {
                const response = await fetch(IMAGE_API_URL);
                if (!response.ok) throw new Error(`Error de GitHub API: ${response.statusText}`);
                const files = await response.json();
                let latestTenidaImage = null;
                let latestTenidaDate = null;
                files.forEach(file => {
                    if (file.type === 'file') {
                        const match = file.name.match(TENIDA_FILENAME_REGEX);
                        if (match) {
                            const year = parseInt(match[1]);
                            const month = parseInt(match[2]);
                            const day = parseInt(match[3]);
                            const date = new Date(year, month - 1, day); 
                            if (!latestTenidaDate || date.getTime() > latestTenidaDate.getTime()) {
                                latestTenidaDate = date;
                                latestTenidaImage = {
                                    src: file.download_url,
                                    alt: `Tenida del ${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`
                                };
                            }
                        }
                    }
                });
                if (latestTenidaImage) {
                    ULTIMA_TENIDA_IMG_ELEMENT.src = latestTenidaImage.src;
                    ULTIMA_TENIDA_IMG_ELEMENT.alt = latestTenidaImage.alt;
                } else {
                    ULTIMA_TENIDA_IMG_ELEMENT.alt = "No se encontró la última tenida (imagen por defecto).";
                }
                ULTIMA_TENIDA_IMG_ELEMENT.classList.remove('loading');
            } catch (error) {
                console.error("Fallo al cargar la última imagen de tenida desde GitHub:", error);
                ULTIMA_TENIDA_IMG_ELEMENT.alt = "Error al cargar la tenida";
                ULTIMA_TENIDA_IMG_ELEMENT.classList.remove('loading');
            }
        }
        
        // =========================================================================
        // === 4. LÓGICA DE LECTURA DE GOOGLE CALENDAR API =========================
        // =========================================================================

        async function fetchNextTenida() {
             /*if (CALENDAR_ID === '9d46fca8679c56e5d9dd7a0800eb446f8a06697c8c3233e162d053b15c9b8dc4@group.calendar.google.com') {
                document.getElementById('tenida-fecha').innerHTML = "⚠️ **Error:** Faltan las claves API/ID de Calendario.";
                return;
            }
             */

            const today = new Date();
            const isoNow = today.toISOString();
            
            // maxResults=1: Solo necesitamos el evento más cercano.
            const apiUrl = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${API_KEY}&singleEvents=true&orderBy=startTime&timeMin=${isoNow}&maxResults=1`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo obtener el calendario.`);
                }
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    document.getElementById('tenida-fecha').textContent = "Próxima fecha pendiente de confirmación en el calendario.";
                    return;
                }

                const nextEvent = data.items[0];
                // nextEvent.start.dateTime es para eventos con hora; nextEvent.start.date es para eventos de día completo
                const startTime = new Date(nextEvent.start.dateTime || nextEvent.start.date);
                
                // 1. FORMATO DE VISUALIZACIÓN
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
                
                const formattedDate = startTime.toLocaleDateString('es-ES', dateOptions);
                const formattedTime = startTime.toLocaleTimeString('es-ES', timeOptions);
                
                document.getElementById('tenida-fecha').innerHTML = `**${formattedDate}** &mdash; ${formattedTime} horas`;

                // 2. GENERACIÓN DEL ENLACE DE GOOGLE CALENDAR
                const locationText = nextEvent.location || document.getElementById('tenida-lugar').textContent.trim().replace(/\s*\n\s*/g, ' ');
                const titleText = nextEvent.summary || "Próxima Tenida";
                
                let eventEndTime = nextEvent.end.dateTime ? new Date(nextEvent.end.dateTime) : new Date(startTime.getTime() + DURATION_HOURS * 60 * 60 * 1000);

                const formatDateForCalendar = (date) => {
                    // Formato ISO simplificado para Google Calendar: AAAAMMDDTHHMMSS
                    const pad = (n) => n < 10 ? '0' + n : n;
                    return date.getUTCFullYear() +
                           pad(date.getUTCMonth() + 1) +
                           pad(date.getUTCDate()) + 'T' +
                           pad(date.getUTCHours()) +
                           pad(date.getUTCMinutes()) +
                           pad(date.getUTCSeconds()) + 'Z'; // Se usa Z (Zulu/UTC) para mayor compatibilidad
                };
                
                const calendarStartTime = formatDateForCalendar(startTime);
                const calendarEndTime = formatDateForCalendar(eventEndTime);

                const calendarURL = new URL("https://calendar.google.com/calendar/render");
                calendarURL.searchParams.set("action", "TEMPLATE");
                calendarURL.searchParams.set("text", titleText);
                calendarURL.searchParams.set("dates", `${calendarStartTime}/${calendarEndTime}`);
                calendarURL.searchParams.set("details", nextEvent.description || "Tenida ordinaria de la logia.");
                calendarURL.searchParams.set("location", locationText);
                calendarURL.searchParams.set("ctz", TIMEZONE);

                const calendarButton = document.getElementById('add-to-calendar-btn');
                if (calendarButton) {
                    calendarButton.href = calendarURL.toString();
                }

            } catch (error) {
                console.error("Fallo al obtener la Tenida desde Google Calendar:", error);
                document.getElementById('tenida-fecha').innerHTML = "Error al cargar la fecha (revisa la consola para detalles).";
            }
        }

        // =========================================================================
        // === 5. LÓGICA DE LIGHTBOX DE GALERÍA E INICIALIZACIÓN ===================
        // =========================================================================
        
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lb-img');
        const lbCaption = document.getElementById('lb-caption');
        const lbClose = document.getElementById('lb-close');

        function initLightbox() {
             // Re-inicializa listeners para que funcione con imágenes cargadas dinámicamente
             const galleryImgs = document.querySelectorAll('#image-gallery img');
             galleryImgs.forEach(img => {
                 img.removeEventListener('click', openLightboxHandler);
                 img.addEventListener('click', openLightboxHandler);
            });
        }
        
        function openLightboxHandler() {
            const full = this.dataset.full || this.src;
            lbImg.src = full;
            lbImg.alt = this.alt || "Imagen Ampliada";
            lightbox.classList.add('open');
            lightbox.setAttribute('aria-hidden', 'false');
            lbCaption.textContent = lbImg.alt;
            lbCaption.style.display = "block";
        }

        function closeLightbox(){
            lightbox.classList.remove('open');
            lightbox.setAttribute('aria-hidden','true');
            lbImg.src = '';
            lbCaption.style.display = "none";
        }
        
        lbClose.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e)=>{
            if(e.target === lightbox) closeLightbox();
        });
        document.addEventListener('keydown', (e)=>{ 
            if(e.key === 'Escape' && lightbox.classList.contains('open')) closeLightbox();
        });


        // --- INICIALIZACIÓN GENERAL ---

        document.addEventListener('DOMContentLoaded', () => {
             // 1. Cargar la lista de trabajos (desde .json)
             loadTrabajos(); 

             // 2. Iniciar la carga de la última imagen de tenida.
             fetchLatestTenidaImage();

             // 3. Inicializar el Lightbox.
             initLightbox();

             // 4. Cargar la próxima Tenida desde Google Calendar API
             fetchNextTenida();

             // 5. Scroll suave
             document.querySelectorAll('a[href^="#"]').forEach(a=>{
                 a.addEventListener('click', e=>{
                     const href = a.getAttribute('href');
                     if(href.length>1 && a.closest('#trabajos-list')===null){ 
                         // Ignora los clics en la lista de trabajos, que tienen su propia función
                         e.preventDefault();
                         const el = document.querySelector(href);
                         if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
                     }
                 });
             });
        });

    </script>
</body>
</html>
